name: Download and Upload File

on:
  workflow_dispatch:
    inputs:
      file_urls:
        description: '要下载的文件URL（多个URL请用换行分隔）'
        required: true
        type: string
      artifact_name:
        description: 'Artifacts名称（可选）'
        required: false
        type: string
        default: ''

permissions:
  contents: read
  actions: write

jobs:
  download-and-upload:
    runs-on: ubuntu-latest
    
    steps:
    - name: 创建下载目录
      run: mkdir -p downloads
      
    - name: 显示下载URL信息
      run: |
        echo "=========================================="
        echo "下载URL列表:"
        echo "${{ inputs.file_urls }}"
        echo "=========================================="
        
    - name: 下载多个文件
      run: |
        # 将URL列表保存到临时文件
        echo "${{ inputs.file_urls }}" > urls.txt
        
        # 初始化计数器和失败标志
        success_count=0
        fail_count=0
        total_count=0
        
        # 逐行读取URL并下载
        while IFS= read -r url; do
          # 跳过空行
          if [ -z "$url" ]; then
            continue
          fi
          
          total_count=$((total_count + 1))
          echo "处理URL $total_count: $url"
          
          # 从URL中提取文件名
          filename=$(basename "$url")
          
          # 如果文件名为空，生成一个默认名称
          if [ -z "$filename" ] || [ "$filename" = "/" ]; then
            filename="file_$total_count"
          fi
          
          echo "下载文件: $filename"
          
          # 下载文件
          if curl -L -f -o "downloads/$filename" "$url"; then
            echo "✓ 文件下载成功: $filename"
            success_count=$((success_count + 1))
            
            # 显示文件信息
            if [ -f "downloads/$filename" ]; then
              size=$(du -h "downloads/$filename" | cut -f1)
              type=$(file -b "downloads/$filename")
              echo "  - 大小: $size"
              echo "  - 类型: $type"
            fi
          else
            echo "✗ 文件下载失败: $filename"
            fail_count=$((fail_count + 1))
          fi
          
          echo "---"
        done < urls.txt
        
        # 显示下载统计
        echo "=========================================="
        echo "下载完成统计:"
        echo "总文件数: $total_count"
        echo "成功: $success_count"
        echo "失败: $fail_count"
        echo "=========================================="
        
        # 如果有失败，设置退出码为1
        if [ $fail_count -gt 0 ]; then
          echo "警告: 有 $fail_count 个文件下载失败"
          # 不退出，继续上传成功的文件
        fi
        
    - name: 上传文件到Artifacts
      run: |
        # 如果artifact_name为空，使用默认名称
        ARTIFACT_NAME="${{ inputs.artifact_name }}"
        if [ -z "$ARTIFACT_NAME" ]; then
          ARTIFACT_NAME="downloaded-files"
        fi
        echo "ARTIFACT_NAME=$ARTIFACT_NAME" >> $GITHUB_ENV
        
    - name: 执行上传
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.ARTIFACT_NAME }}
        path: downloads/
        retention-days: 30
        if-no-files-found: warn